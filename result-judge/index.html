<!DOCTYPE html>
<html>
<body>
    <!-- Scratch Includes -->
    <script src="lib/scratch-vm.min.js">       </script>
    <script src="lib/scratch-storage.min.js">  </script>
    <script src="lib/scratch-svg-renderer.js"> </script>
    <script src="lib/audio_engine.js">         </script>
    <script src="lib/scratch-render.min.js">   </script>
    <script src="proxy-library.js">            </script>
    <script src="test/test_functions/test-functions.js">                </script>

    <h1 id="status">Result Scratch Tester</h1>
    <canvas id="canvas" width="480" height="360" style="width: 480px"></canvas>
    <input type="file" id="file" name="file">

    <script>
        // maybe don't use global here
        var logData = {index:0, lines:[], color:null, points:[]};

        window.devicePixelRatio = 1;

        /*
            Creates the ScratchVM and attach it to a canvas  
        */
        function makeScratchVM(canvas) {
            var render  = makeProxiedRenderer(canvas, logData);
            var vm      = new VirtualMachine();
            const audioEngine = new AudioEngine();
            vm.attachAudioEngine(audioEngine);
            const storage = new ScratchStorage();
            vm.attachStorage(storage);
            vm.attachRenderer(render);
            vm.attachV2SVGAdapter(new ScratchSVGRenderer.SVGRenderer());
            var adaptor  = new ScratchSVGRenderer.BitmapAdapter();
            vm.attachV2BitmapAdapter(adaptor);
            vm.render = render; 
            return vm;
        }

        var canvas  = document.getElementById('canvas');
        var vm      = makeScratchVM(canvas);        

        document.getElementById('file').addEventListener('change', e => {
            const reader = new FileReader();
            const thisFileInput = e.target;
            reader.onload = () => {
                vm.start();
                vm.setTurboMode(true);
                vm.loadProject(reader.result)
                    .then(() => {
                        vm.greenFlag();
                        // we add a `#loaded` div to our document, the integration suite
                        // waits for that element to show up to assume the vm is ready
                        // to play!
                        const div = document.createElement('div');
                        div.id='loaded';
                        document.body.appendChild(div);
                        console.log(vm);
                    });
            };
            reader.readAsArrayBuffer(thisFileInput.files[0]);
        });

        function getLog() {
            return logData;
        }
        
	    </script>
</body>
</html>
