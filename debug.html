<!doctype html>

<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Itch Debug</title>
</head>
<body>
<h2>Itch Debug</h2>

<canvas id="scratch-stage"></canvas>

<h1>Output</h1>
<div id="output">

</div>

<!-- Scratch libraries -->
<!-- Scratch libraries -->
<!-- Audio module -->
<!-- Doesn't work :( -->
<!--<script src="../node_modules/scratch-audio/dist.js"></script>-->
<!-- Storage module -->
<script src="node_modules/scratch-storage/dist/web/scratch-storage.js"></script>
<!-- Stage rendering -->
<script src="node_modules/scratch-render/dist/web/scratch-render.js"></script>
<!-- SVG rendering -->
<script src="node_modules/scratch-svg-renderer/dist/web/scratch-svg-renderer.js"></script>
<!-- VM -->
<script src="node_modules/scratch-vm/dist/web/scratch-vm.js"></script>

<!-- Utils -->
<script src="node_modules/lodash/lodash.min.js"></script>
<script src="node_modules/itch-judge/dist/js/judge.browser.js"></script>

<!-- Scratch Judge -->
<script src="scratch/collector.js"></script>

<script>
  const configPath = 'config.json';
  window.handleOut = (r) => console.log(r);
  
  fetch(configPath)
  .then(r => r.json())
  .then(async config => {
    // Load test plan.
    const planPath = config.resources + '/' + config.plan;
    const plan = await fetch(planPath).then(r => r.text());
    eval.apply(this, [plan]);
    const template = await fetch(config.template).then(r => r.arrayBuffer());
    const submission = await fetch(config.source).then(r => r.arrayBuffer());

    const inputs = {
      submission: submission,
      template: template,
      canvas: document.getElementById('scratch-stage')
    };

    // Hook up the output visualizer.
    init(document.getElementById('output'));

    // Main function of the Itch judge, exposed by the evaluation module.
    await window.run(inputs);
  });
</script>

</body>
</html>
